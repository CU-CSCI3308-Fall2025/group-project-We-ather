<div class="container pb-10 m-10" data-current-user="{{username}}">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="mb-0">Your Posts</h3>
    <div id="feed-filter-info" class="d-none">
      <span id="filter-location-text" class="text-muted me-2"></span>
      <button id="clear-filter-btn" class="btn btn-sm btn-outline-secondary">Show All Posts</button>
    </div>
  </div>
  <div id="feed-loading" class="text-center py-4 d-none">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>
  <div id="feed-container">
    <p class="text-muted">Loading posts...</p>
  </div>
</div>

<script>
  // Store initial posts for "Show All" functionality
  let allPosts = [];
  let currentFilter = null;
  // Current logged-in username (from template)
  const currentUser = document.querySelector('.container[data-current-user]')?.dataset.currentUser || null;

  // Load posts on page load
  document.addEventListener('DOMContentLoaded', () => {
    loadPosts();
  });

  // Function to format date
  function formatDate(dateString) {
    if (!dateString) return '';
    const d = new Date(dateString);
    return d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
  }

  // Function to escape HTML to prevent XSS
  function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // Function to render posts
  function renderPosts(posts) {
    const container = document.getElementById('feed-container');
    if (!posts || posts.length === 0) {
      container.innerHTML = '<p class="text-muted">No posts found for your account.</p>';
      return;
    }

    const postsHtml = posts.map(post => {
      const postId = post.id;
      const escapedContent = escapeHtml(post.content || '');
      return `
      <div class="col-md-6 col-lg-4 mt-4">
        <div class="card shadow-sm h-100" data-post-id="${postId}">
          ${post.image_filename ? `<img src="/uploads/${post.image_filename}" class="card-img-top" alt="Weather photo" style="height: 200px; object-fit: cover;">` : ''}
          <div class="card-body d-flex flex-column">
            <div class="post-content-container" data-post-id="${postId}">
              ${post.content ? `<p class="card-text post-content">${escapedContent}</p>` : '<p class="card-text post-content text-muted">No content</p>'}
            </div>
            <div class="mt-auto">
              <div class="d-flex justify-content-between align-items-center">
                <small class="text-muted">
                  <strong>${escapeHtml(post.username)}</strong>
                  ${post.location ? ` â€¢ ${escapeHtml(post.location)}` : ''}
                  <br>
                  <span class="text-muted">${formatDate(post.created_at)}</span>
                </small>
                ${post.can_delete ? `
                  <div class="btn-group" role="group">
                    <button class="btn btn-sm btn-outline-primary edit-post-btn" data-post-id="${postId}" title="Edit post">
                      <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger delete-post-btn" data-post-id="${postId}" title="Delete post">
                      <i class="bi bi-trash"></i>
                    </button>
                  </div>
                ` : ''}
              </div>
            </div>
          </div>
        </div>
      </div>
    `;
    }).join('');

    container.innerHTML = `<div class="row">${postsHtml}</div>`;
  }

  // Function to load posts with optional location filter
  async function loadPosts(location = null) {
    const loadingEl = document.getElementById('feed-loading');
    const filterInfo = document.getElementById('feed-filter-info');
    const filterText = document.getElementById('filter-location-text');
    const clearBtn = document.getElementById('clear-filter-btn');

    loadingEl.classList.remove('d-none');

    try {
      const url = location ? `/api/posts?location=${encodeURIComponent(location)}` : '/api/posts';
      const response = await fetch(url);
      const posts = await response.json();

      // If a current user is available, filter posts to only that user
      let visiblePosts = posts;
      if (currentUser) {
        visiblePosts = posts.filter(p => p.username === currentUser || String(p.username) === String(currentUser));
      }

      if (!location) {
        allPosts = visiblePosts;
        currentFilter = null;
        filterInfo.classList.add('d-none');
      } else {
        currentFilter = location;
        filterText.textContent = `Showing posts from: ${location}`;
        filterInfo.classList.remove('d-none');
      }

      renderPosts(visiblePosts);
    } catch (error) {
      console.error('Error loading posts:', error);
      document.getElementById('feed-container').innerHTML = '<p class="text-danger">Error loading posts. Please try again.</p>';
    } finally {
      loadingEl.classList.add('d-none');
    }
  }

  // Clear filter button handler
  const clearBtn = document.getElementById('clear-filter-btn');
  if (clearBtn) {
    clearBtn.addEventListener('click', () => {
      loadPosts();
    });
  }

  // Expose loadPosts globally so search can call it
  window.loadPostsByLocation = loadPosts;

  // Handle edit post buttons
  document.addEventListener('click', async (e) => {
    if (e.target.closest('.edit-post-btn')) {
      const btn = e.target.closest('.edit-post-btn');
      const postId = btn.getAttribute('data-post-id');
      
      if (!postId) return;

      const contentContainer = document.querySelector(`.post-content-container[data-post-id="${postId}"]`);
      if (!contentContainer) return;

      const contentElement = contentContainer.querySelector('.post-content');
      const currentContent = contentElement ? contentElement.textContent : '';

      // Check if already in edit mode
      if (contentContainer.querySelector('.edit-form')) {
        return;
      }

      // Create edit form
      const editForm = document.createElement('div');
      editForm.className = 'edit-form';
      editForm.innerHTML = `
        <textarea class="form-control mb-2 edit-content-textarea" rows="3" style="min-height: 80px;">${escapeHtml(currentContent)}</textarea>
        <div class="d-flex gap-2">
          <button class="btn btn-sm btn-success save-edit-btn" data-post-id="${postId}">
            <i class="bi bi-check"></i> Save
          </button>
          <button class="btn btn-sm btn-secondary cancel-edit-btn" data-post-id="${postId}">
            <i class="bi bi-x"></i> Cancel
          </button>
        </div>
      `;

      // Replace content with edit form
      contentContainer.innerHTML = '';
      contentContainer.appendChild(editForm);

      // Focus on textarea
      const textarea = editForm.querySelector('.edit-content-textarea');
      if (textarea) {
        textarea.focus();
        textarea.setSelectionRange(textarea.value.length, textarea.value.length);
      }
    }

    // Handle save edit
    if (e.target.closest('.save-edit-btn')) {
      const btn = e.target.closest('.save-edit-btn');
      const postId = btn.getAttribute('data-post-id');
      
      if (!postId) {
        console.error('Post ID not found');
        alert('Error: Post ID not found');
        return;
      }

      const contentContainer = document.querySelector(`.post-content-container[data-post-id="${postId}"]`);
      if (!contentContainer) {
        console.error('Content container not found for post ID:', postId);
        return;
      }

      const textarea = contentContainer.querySelector('.edit-content-textarea');
      if (!textarea) {
        console.error('Textarea not found');
        return;
      }

      const newContent = textarea.value.trim();
      
      // Validate postId is a number
      const postIdNum = parseInt(postId, 10);
      if (isNaN(postIdNum) || postIdNum <= 0) {
        console.error('Invalid post ID:', postId);
        alert('Error: Invalid post ID');
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-check"></i> Save';
        return;
      }
      
      const url = `/api/posts/${postIdNum}`;
      console.log('Updating post:', { postId, postIdNum, url, content: newContent });

      // Disable button during save
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

      try {
        const response = await fetch(url, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ content: newContent })
        });

        // Check if response is JSON
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
          const text = await response.text();
          console.error('Non-JSON response received:', response.status, response.statusText, text.substring(0, 200));
          alert(`Error: Server returned ${response.status} ${response.statusText}. Please check the console for details.`);
          btn.disabled = false;
          btn.innerHTML = '<i class="bi bi-check"></i> Save';
          return;
        }

        const data = await response.json();

        if (response.ok && data.success) {
          // Reload posts after successful update
          await loadPosts(currentFilter);
        } else {
          const errorMsg = data.error || data.message || 'Failed to update post';
          console.error('Update post error:', errorMsg, data);
          alert(errorMsg);
          btn.disabled = false;
          btn.innerHTML = '<i class="bi bi-check"></i> Save';
        }
      } catch (error) {
        console.error('Error updating post:', error);
        alert('Error updating post: ' + error.message);
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-check"></i> Save';
      }
    }

    // Handle cancel edit
    if (e.target.closest('.cancel-edit-btn')) {
      const btn = e.target.closest('.cancel-edit-btn');
      const postId = btn.getAttribute('data-post-id');
      
      if (!postId) return;

      // Reload posts to restore original content
      await loadPosts(currentFilter);
    }
  });

  // Handle delete post buttons
  document.addEventListener('click', async (e) => {
    if (e.target.closest('.delete-post-btn')) {
      const btn = e.target.closest('.delete-post-btn');
      const postId = btn.getAttribute('data-post-id');
      
      if (!postId) return;

      // Confirm deletion
      if (!confirm('Are you sure you want to delete this post? This action cannot be undone.')) {
        return;
      }

      // Disable button during deletion
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

      try {
        const response = await fetch(`/api/posts/${postId}`, {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json'
          }
        });

        const data = await response.json();

        if (response.ok && data.success) {
          // Reload posts after successful deletion
          await loadPosts(currentFilter);
        } else {
          alert(data.error || 'Failed to delete post');
          btn.disabled = false;
          btn.innerHTML = '<i class="bi bi-trash"></i>';
        }
      } catch (error) {
        console.error('Error deleting post:', error);
        alert('Error deleting post. Please try again.');
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-trash"></i>';
      }
    }
  });
</script>