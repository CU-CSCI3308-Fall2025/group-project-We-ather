<form id="location-search-form" class="d-flex align-items-center" role="search" aria-label="Search location">
  <div class="input-group w-100 position-relative">
    <input
      id="location-input"
      name="location"
      type="search"
      class="form-control"
      placeholder="Search city, address, or place (e.g. Boulder, CO)"
      aria-label="Search location"
      required
      autocomplete="off"
      aria-autocomplete="list"
      aria-expanded="false"
      aria-controls="autocomplete-results"
    />
    <button class="btn btn-primary" type="submit" id="location-search-btn">
      <span id="search-btn-text">Search</span>
      <span id="search-spinner" class="spinner-border spinner-border-sm ms-2 d-none" role="status" aria-hidden="true"></span>
    </button>
    <!-- Autocomplete dropdown -->
    <div id="autocomplete-results" class="autocomplete-dropdown" role="listbox" aria-label="Location suggestions"></div>
  </div>

  <input type="hidden" id="latitude" name="lat" />
  <input type="hidden" id="longitude" name="lon" />
</form>

<div class="mt-2">
  <label for="saved-locations-dropdown" class="form-label small text-muted">Saved Locations:</label>
  <div id="saved-locations-container" class="saved-locations-list">
    <div class="text-muted small p-2">Loading saved locations...</div>
  </div>
</div>

<div id="search-message-container" class="mt-2 d-flex align-items-center gap-2" role="status" aria-live="polite">
  <span id="search-message" class="text-muted"></span>
  <button id="save-city-btn" class="btn btn-sm btn-outline-success d-none" type="button" title="Save this city to your saved cities list">
    <i class="bi bi-bookmark-plus"></i> Save
  </button>
</div>

<style>
  .autocomplete-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #ced4da;
    border-top: none;
    border-radius: 0 0 0.375rem 0.375rem;
    max-height: 300px;
    overflow-y: auto;
    z-index: 1000;
    display: none;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  }

  .autocomplete-dropdown.show {
    display: block;
  }

  .autocomplete-item {
    padding: 0.75rem 1rem;
    cursor: pointer;
    border-bottom: 1px solid #f0f0f0;
    transition: background-color 0.2s;
  }

  .autocomplete-item:hover,
  .autocomplete-item.active {
    background-color: #f8f9fa;
  }

  .autocomplete-item:last-child {
    border-bottom: none;
  }

  .autocomplete-item-name {
    font-weight: 500;
    color: #212529;
  }

  .autocomplete-item-details {
    font-size: 0.875rem;
    color: #6c757d;
    margin-top: 0.25rem;
  }

  .input-group {
    position: relative;
  }

  .saved-locations-list {
    border: 1px solid #ced4da;
    border-radius: 0.375rem;
    background: white;
    max-height: 200px;
    overflow-y: auto;
  }

  .saved-location-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.5rem 0.75rem;
    border-bottom: 1px solid #f0f0f0;
    cursor: pointer;
    transition: background-color 0.2s;
  }

  .saved-location-item:last-child {
    border-bottom: none;
  }

  .saved-location-item:hover {
    background-color: #f8f9fa;
  }

  .saved-location-text {
    flex: 1;
    font-size: 0.875rem;
    color: #212529;
  }

  .saved-location-delete {
    background: none;
    border: none;
    color: #dc3545;
    font-size: 1.1rem;
    cursor: pointer;
    padding: 0.25rem 0.5rem;
    line-height: 1;
    opacity: 0.7;
    transition: opacity 0.2s;
  }

  .saved-location-delete:hover {
    opacity: 1;
    color: #c82333;
  }

  .saved-location-delete:focus {
    outline: 2px solid #dc3545;
    outline-offset: 2px;
    border-radius: 0.25rem;
  }

  .saved-locations-empty {
    padding: 0.75rem;
    text-align: center;
    color: #6c757d;
    font-size: 0.875rem;
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const form = document.getElementById('location-search-form');
  const input = document.getElementById('location-input');
  const msg = document.getElementById('search-message');
  const btnText = document.getElementById('search-btn-text');
  const spinner = document.getElementById('search-spinner');
  const saveBtn = document.getElementById('save-city-btn');
  const autocompleteResults = document.getElementById('autocomplete-results');
  const savedLocationsContainer = document.getElementById('saved-locations-container');
  
  let autocompleteTimeout = null;
  let selectedIndex = -1;
  let currentSuggestions = [];
  // Store the current search query
  let currentSearchQuery = '';

  // Load saved locations into container
  async function loadSavedLocations() {
    try {
      const response = await fetch('/api/saved-locations');
      if (response.ok) {
        const locations = await response.json();
        
        // Clear container
        savedLocationsContainer.innerHTML = '';
        
        if (locations.length === 0) {
          savedLocationsContainer.innerHTML = '<div class="saved-locations-empty">No saved locations</div>';
        } else {
          locations.forEach(location => {
            const item = document.createElement('div');
            item.className = 'saved-location-item';
            
            const text = document.createElement('span');
            text.className = 'saved-location-text';
            text.textContent = location;
            
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'saved-location-delete';
            deleteBtn.innerHTML = 'Ã—';
            deleteBtn.setAttribute('aria-label', `Delete ${location}`);
            deleteBtn.type = 'button';
            
            // Handle click on entire item - autofill and search
            item.addEventListener('click', (e) => {
              // Don't trigger if clicking the delete button
              if (e.target === deleteBtn || deleteBtn.contains(e.target)) {
                return;
              }
              input.value = location;
              form.dispatchEvent(new Event('submit'));
            });
            
            // Handle delete button click
            deleteBtn.addEventListener('click', async (e) => {
              e.stopPropagation(); // Prevent triggering the item click
              if (confirm(`Delete "${location}" from saved locations?`)) {
                try {
                  const deleteResponse = await fetch('/api/saved-locations', {
                    method: 'DELETE',
                    headers: {
                      'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ location_text: location }),
                  });
                  
                  if (deleteResponse.ok) {
                    // Reload the list
                    loadSavedLocations();
                  } else {
                    const data = await deleteResponse.json();
                    alert(data.error || 'Failed to delete location');
                  }
                } catch (err) {
                  console.error('Error deleting location:', err);
                  alert('Error deleting location');
                }
              }
            });
            
            item.appendChild(text);
            item.appendChild(deleteBtn);
            savedLocationsContainer.appendChild(item);
          });
        }
      }
    } catch (err) {
      console.error('Error loading saved locations:', err);
      savedLocationsContainer.innerHTML = '<div class="saved-locations-empty text-danger">Error loading saved locations</div>';
    }
  }

  // Load saved locations on page load
  loadSavedLocations();

  // Autocomplete functionality
  async function fetchAutocompleteSuggestions(query) {
    if (!query || query.length < 2) {
      hideAutocomplete();
      return;
    }

    try {
      // Use OpenStreetMap Nominatim API for autocomplete
      // Only search within US (countrycodes=us) since weather.gov API only supports US locations
      const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&limit=5&addressdetails=1&countrycodes=us`;
      const response = await fetch(url, {
        headers: {
          'Accept': 'application/json',
          'User-Agent': 'We-ather App'
        }
      });
      
      if (!response.ok) {
        return;
      }

      const places = await response.json();
      // Filter to only include places with US in the address
      const usPlaces = places.filter(place => {
        const address = place.address || {};
        return address.country_code === 'us' || 
               place.display_name.toLowerCase().includes(', united states') ||
               place.display_name.toLowerCase().includes(', usa') ||
               place.display_name.toLowerCase().includes(', us');
      });
      
      // Deduplicate by City, State format
      const seen = new Set();
      const uniquePlaces = usPlaces.filter(place => {
        const locationParts = place.display_name.split(',');
        const cityState = locationParts.slice(0, 2).join(',').trim().toLowerCase() || locationParts[0].trim().toLowerCase();
        if (seen.has(cityState)) {
          return false;
        }
        seen.add(cityState);
        return true;
      });
      
      currentSuggestions = uniquePlaces;
      displayAutocomplete(uniquePlaces);
    } catch (error) {
      console.error('Error fetching autocomplete:', error);
      hideAutocomplete();
    }
  }

  function displayAutocomplete(suggestions) {
    if (!suggestions || suggestions.length === 0) {
      hideAutocomplete();
      return;
    }

    autocompleteResults.innerHTML = '';
    suggestions.forEach((place, index) => {
      const item = document.createElement('div');
      item.className = 'autocomplete-item';
      item.setAttribute('role', 'option');
      item.setAttribute('data-index', index);
      
      const name = place.display_name.split(',')[0];
      const details = place.display_name.split(',').slice(1, 3).join(',').trim();
      
      item.innerHTML = `
        <div class="autocomplete-item-name">${name}</div>
        ${details ? `<div class="autocomplete-item-details">${details}</div>` : ''}
      `;
      
      item.addEventListener('click', () => {
        selectSuggestion(place);
      });
      
      item.addEventListener('mouseenter', () => {
        selectedIndex = index;
        updateActiveItem();
      });
      
      autocompleteResults.appendChild(item);
    });

    autocompleteResults.classList.add('show');
    input.setAttribute('aria-expanded', 'true');
    selectedIndex = -1;
  }

  function hideAutocomplete() {
    autocompleteResults.classList.remove('show');
    autocompleteResults.innerHTML = '';
    input.setAttribute('aria-expanded', 'false');
    selectedIndex = -1;
    currentSuggestions = [];
  }

  function selectSuggestion(place) {
    input.value = place.display_name;
    document.getElementById('latitude').value = place.lat;
    document.getElementById('longitude').value = place.lon;
    hideAutocomplete();
    // Optionally trigger search automatically
    // form.dispatchEvent(new Event('submit'));
  }

  function updateActiveItem() {
    const items = autocompleteResults.querySelectorAll('.autocomplete-item');
    items.forEach((item, index) => {
      if (index === selectedIndex) {
        item.classList.add('active');
      } else {
        item.classList.remove('active');
      }
    });
  }

  // Input event listener for autocomplete
  input.addEventListener('input', (e) => {
    const query = e.target.value.trim();
    
    // Clear previous timeout
    if (autocompleteTimeout) {
      clearTimeout(autocompleteTimeout);
    }

    // Debounce autocomplete requests
    autocompleteTimeout = setTimeout(() => {
      fetchAutocompleteSuggestions(query);
    }, 300);
  });

  // Handle keyboard navigation
  input.addEventListener('keydown', (e) => {
    if (!autocompleteResults.classList.contains('show') || currentSuggestions.length === 0) {
      return;
    }

    switch(e.key) {
      case 'ArrowDown':
        e.preventDefault();
        selectedIndex = Math.min(selectedIndex + 1, currentSuggestions.length - 1);
        updateActiveItem();
        break;
      case 'ArrowUp':
        e.preventDefault();
        selectedIndex = Math.max(selectedIndex - 1, -1);
        updateActiveItem();
        break;
      case 'Enter':
        if (selectedIndex >= 0 && currentSuggestions[selectedIndex]) {
          e.preventDefault();
          selectSuggestion(currentSuggestions[selectedIndex]);
        }
        break;
      case 'Escape':
        hideAutocomplete();
        break;
    }
  });

  // Hide autocomplete when clicking outside
  document.addEventListener('click', (e) => {
    if (!form.contains(e.target)) {
      hideAutocomplete();
    }
  });

  // Hide autocomplete when input loses focus (with a small delay to allow clicks)
  input.addEventListener('blur', () => {
    setTimeout(() => {
      hideAutocomplete();
    }, 200);
  });

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    hideAutocomplete(); // Hide autocomplete when submitting
    msg.textContent = '';
    saveBtn.classList.add('d-none');
    const q = (input.value || '').trim();
    if (!q) {
      msg.textContent = 'Please enter a location.';
      return;
    }

    // Store the search query for saving later
    currentSearchQuery = q;

    spinner.classList.remove('d-none');
    btnText.textContent = 'Searching';

    try {
      // Only search within US (countrycodes=us) since weather.gov API only supports US locations
      const geocodeUrl = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(q)}&format=json&limit=5&countrycodes=us`;
      const geoRes = await fetch(geocodeUrl, { headers: { 'Accept': 'application/json' } });
      const places = await geoRes.json();

      if (!places || places.length === 0) {
        msg.textContent = 'No matching US location found. Weather data is only available for locations in the United States.';
        return;
      }

      // Filter to ensure it's a US location
      const usPlace = places.find(place => {
        const address = place.address || {};
        return address.country_code === 'us' || 
               place.display_name.toLowerCase().includes(', united states') ||
               place.display_name.toLowerCase().includes(', usa') ||
               place.display_name.toLowerCase().includes(', us');
      });

      if (!usPlace) {
        msg.textContent = 'No matching US location found. Weather data is only available for locations in the United States.';
        return;
      }

      const { lat, lon, display_name } = usPlace;
      document.getElementById('latitude').value = lat;
      document.getElementById('longitude').value = lon;

      msg.textContent = `Loading weather for ${display_name}...`;

      const weatherRes = await fetch(`/api/weather?lat=${lat}&lon=${lon}`);
      if (!weatherRes.ok) {
        msg.textContent = 'Failed to get weather (server error).';
        return;
      }

      const weather = await weatherRes.json();
      
      if (typeof displayWeather === 'function') {
        displayWeather(weather);
        msg.textContent = `Showing weather for ${display_name}`;

        
        // Show save button after successful search
        saveBtn.classList.remove('d-none');
      } else {
        msg.textContent = 'Weather display function not available.';
      }

      // Filter posts by location
      if (typeof window.loadPostsByLocation === 'function') {
        // Extract location from display_name (format is usually "City, State, Country")
        const locationParts = display_name.split(',');
        // Use city, state format for better matching (e.g., "Boulder, CO")
        const searchLocation = locationParts.slice(0, 2).join(',').trim() || locationParts[0].trim();
        window.loadPostsByLocation(searchLocation);
      }
    } catch (err) {
      console.error(err);
      msg.textContent = 'Error searching location.';
    } finally {
      spinner.classList.add('d-none');
      btnText.textContent = 'Search';
    }
  });

  // Add click handler to save button
  saveBtn.addEventListener('click', async () => {
    if (!currentSearchQuery) {
      msg.textContent = 'No location to save.';
      return;
    }

    try {
      const response = await fetch('/api/saved-locations', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ location_text: currentSearchQuery }),
      });

      const data = await response.json();

      if (response.ok) {
        msg.textContent = `Saved: ${currentSearchQuery}`;
        saveBtn.classList.add('d-none');
        // Reload saved locations dropdown
        loadSavedLocations();
      } else {
        msg.textContent = data.error || 'Failed to save location.';
      }
    } catch (err) {
      console.error('Error saving location:', err);
      msg.textContent = 'Error saving location.';
    }
  });
});
</script>