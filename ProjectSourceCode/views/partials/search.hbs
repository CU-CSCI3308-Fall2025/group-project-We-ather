<form id="location-search-form" class="d-flex align-items-center" role="search" aria-label="Search location">
  <div class="input-group w-100">
    <input
      id="location-input"
      name="location"
      type="search"
      class="form-control"
      placeholder="Search city, address, or place (e.g. Boulder, CO)"
      aria-label="Search location"
      required
      autocomplete="off"
    />
    <button class="btn btn-primary" type="submit" id="location-search-btn">
      <span id="search-btn-text">Search</span>
      <span id="search-spinner" class="spinner-border spinner-border-sm ms-2 d-none" role="status" aria-hidden="true"></span>
    </button>
  </div>

  <!-- Hidden fields for lat/lon -->
  <input type="hidden" id="latitude" name="lat" />
  <input type="hidden" id="longitude" name="lon" />
</form>

<div id="search-message" class="mt-2 text-muted" role="status" aria-live="polite"></div>
<div id="weather-result" class="mt-3"></div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const form = document.getElementById('location-search-form');
  const input = document.getElementById('location-input');
  const msg = document.getElementById('search-message');
  const btnText = document.getElementById('search-btn-text');
  const spinner = document.getElementById('search-spinner');
  const result = document.getElementById('weather-result');

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    msg.textContent = '';
    result.innerHTML = '';
    const q = (input.value || '').trim();
    if (!q) {
      msg.textContent = 'Please enter a location.';
      return;
    }

    spinner.classList.remove('d-none');
    btnText.textContent = 'Searching';

    try {
      const geocodeUrl = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(q)}&format=json&limit=1`;
      const geoRes = await fetch(geocodeUrl, { headers: { 'Accept': 'application/json' } });
      const places = await geoRes.json();

      if (!places || places.length === 0) {
        msg.textContent = 'No matching location found.';
        return;
      }

      const { lat, lon, display_name } = places[0];
      document.getElementById('latitude').value = lat;
      document.getElementById('longitude').value = lon;

      msg.textContent = `Loading weather for ${display_name}...`;

      const weatherRes = await fetch(`/api/weather?lat=${lat}&lon=${lon}`);
      if (!weatherRes.ok) {
        msg.textContent = 'Failed to get weather (server error).';
        return;
      }

      const weather = await weatherRes.json();
      result.innerHTML = `<pre class="bg-light p-2 rounded small">${escapeHtml(JSON.stringify(weather, null, 2))}</pre>`;
      msg.textContent = `Showing weather for ${display_name}`;
    } catch (err) {
      console.error(err);
      msg.textContent = 'Error searching location.';
    } finally {
      spinner.classList.add('d-none');
      btnText.textContent = 'Search';
    }
  });

  function escapeHtml(s) {
    return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
  }
});
</script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const form = document.getElementById('location-search-form');
  const input = document.getElementById('location-input');
  const msg = document.getElementById('search-message');

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const q = input.value && input.value.trim();
    msg.textContent = '';

    if (!q) {
      msg.textContent = 'Please enter a location.';
      return;
    }

    try {
      // Geocode using Nominatim
      const geocodeUrl = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(q)}&format=json&limit=1`;
      const geoRes = await fetch(geocodeUrl, { headers: { 'User-Agent': 'We-ather-App/1.0' }});
      const places = await geoRes.json();

      if (!places || places.length === 0) {
        msg.textContent = 'No matching location found.';
        return;
      }

      const { lat, lon, display_name } = places[0];

      // Optional: populate hidden fields
      document.getElementById('latitude').value = lat;
      document.getElementById('longitude').value = lon;

      msg.textContent = `Showing weather for ${display_name}...`;

      // Request your weather API (adjust path/headers/auth as needed)
      const weatherRes = await fetch(`/api/weather?lat=${lat}&lon=${lon}`);
      if (!weatherRes.ok) {
        msg.textContent = 'Failed to get weather (server error).';
        return;
      }
      const weather = await weatherRes.json();

      // TODO: render weather into page; for now show JSON
      console.log('weather', weather);
      msg.textContent = `Weather received â€” open console to inspect.`;
    } catch (err) {
      console.error(err);
      msg.textContent = 'Error searching location.';
    }
  });
});
</script>