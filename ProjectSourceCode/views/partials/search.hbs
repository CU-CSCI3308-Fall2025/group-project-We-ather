<form id="location-search-form" class="d-flex align-items-center" role="search" aria-label="Search location">
  <div class="input-group w-100">
    <input
      id="location-input"
      name="location"
      type="search"
      class="form-control"
      placeholder="Search city, address, or place (e.g. Boulder, CO)"
      aria-label="Search location"
      required
      autocomplete="off"
    />
    <button class="btn btn-primary" type="submit" id="location-search-btn">
      <span id="search-btn-text">Search</span>
      <span id="search-spinner" class="spinner-border spinner-border-sm ms-2 d-none" role="status" aria-hidden="true"></span>
    </button>
  </div>

  <input type="hidden" id="latitude" name="lat" />
  <input type="hidden" id="longitude" name="lon" />
</form>

<div class="mt-2">
  <label for="saved-locations-dropdown" class="form-label small text-muted">Saved Locations:</label>
  <select id="saved-locations-dropdown" class="form-select form-select-sm">
    <option value="">Select a saved location...</option>
  </select>
</div>

<div id="search-message-container" class="mt-2 d-flex align-items-center gap-2" role="status" aria-live="polite">
  <span id="search-message" class="text-muted"></span>
  <button id="save-city-btn" class="btn btn-sm btn-outline-success d-none" type="button" title="Save this city to your saved cities list">
    <i class="bi bi-bookmark-plus"></i> Save
  </button>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const form = document.getElementById('location-search-form');
  const input = document.getElementById('location-input');
  const msg = document.getElementById('search-message');
  const btnText = document.getElementById('search-btn-text');
  const spinner = document.getElementById('search-spinner');
  const saveBtn = document.getElementById('save-city-btn');
  const savedLocationsDropdown = document.getElementById('saved-locations-dropdown');
  
  // Store the current search query
  let currentSearchQuery = '';

  // Load saved locations into dropdown
  async function loadSavedLocations() {
    try {
      const response = await fetch('/api/saved-locations');
      if (response.ok) {
        const locations = await response.json();
        // Clear existing options except the first one
        savedLocationsDropdown.innerHTML = '<option value="">Select a saved location...</option>';
        
        if (locations.length === 0) {
          savedLocationsDropdown.innerHTML += '<option value="" disabled>No saved locations</option>';
        } else {
          locations.forEach(location => {
            const option = document.createElement('option');
            option.value = location;
            option.textContent = location;
            savedLocationsDropdown.appendChild(option);
          });
        }
      }
    } catch (err) {
      console.error('Error loading saved locations:', err);
    }
  }

  // Load saved locations on page load
  loadSavedLocations();

  // Handle dropdown selection - autofill search bar
  savedLocationsDropdown.addEventListener('change', (e) => {
    const selectedLocation = e.target.value;
    if (selectedLocation) {
      input.value = selectedLocation;
      // Reset dropdown to default option
      savedLocationsDropdown.value = '';
      // Trigger search automatically
      form.dispatchEvent(new Event('submit'));
    }
  });

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    msg.textContent = '';
    saveBtn.classList.add('d-none');
    const q = (input.value || '').trim();
    if (!q) {
      msg.textContent = 'Please enter a location.';
      return;
    }

    // Store the search query for saving later
    currentSearchQuery = q;

    spinner.classList.remove('d-none');
    btnText.textContent = 'Searching';

    try {
      const geocodeUrl = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(q)}&format=json&limit=1`;
      const geoRes = await fetch(geocodeUrl, { headers: { 'Accept': 'application/json' } });
      const places = await geoRes.json();

      if (!places || places.length === 0) {
        msg.textContent = 'No matching location found.';
        return;
      }

      const { lat, lon, display_name } = places[0];
      document.getElementById('latitude').value = lat;
      document.getElementById('longitude').value = lon;

      msg.textContent = `Loading weather for ${display_name}...`;

      const weatherRes = await fetch(`/api/weather?lat=${lat}&lon=${lon}`);
      if (!weatherRes.ok) {
        msg.textContent = 'Failed to get weather (server error).';
        return;
      }

      const weather = await weatherRes.json();
      
      if (typeof displayWeather === 'function') {
        displayWeather(weather);
        msg.textContent = `Showing weather for ${display_name}`;

        
        // Show save button after successful search
        saveBtn.classList.remove('d-none');
      } else {
        msg.textContent = 'Weather display function not available.';
      }
    } catch (err) {
      console.error(err);
      msg.textContent = 'Error searching location.';
    } finally {
      spinner.classList.add('d-none');
      btnText.textContent = 'Search';
    }
  });

  // Add click handler to save button
  saveBtn.addEventListener('click', async () => {
    if (!currentSearchQuery) {
      msg.textContent = 'No location to save.';
      return;
    }

    try {
      const response = await fetch('/api/saved-locations', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ location_text: currentSearchQuery }),
      });

      const data = await response.json();

      if (response.ok) {
        msg.textContent = `Saved: ${currentSearchQuery}`;
        saveBtn.classList.add('d-none');
        // Reload saved locations dropdown
        loadSavedLocations();
      } else {
        msg.textContent = data.error || 'Failed to save location.';
      }
    } catch (err) {
      console.error('Error saving location:', err);
      msg.textContent = 'Error saving location.';
    }
  });
});
</script>